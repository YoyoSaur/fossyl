# @fossyl/prisma-kysely - AI Development Guide

**Database adapter for fossyl with automatic transaction handling**

## Overview

`@fossyl/prisma-kysely` provides automatic transaction handling for fossyl applications using Prisma for schema management and Kysely for type-safe queries. It uses AsyncLocalStorage and a proxy pattern to transparently route queries through active transactions.

## Installation

```bash
npm install @fossyl/prisma-kysely
# Also requires peer dependencies
npm install kysely prisma
```

## Quick Start

### 1. Configure in fossyl.config.ts

```typescript
import { defineConfig } from 'fossyl';
import { expressAdapter } from '@fossyl/express';
import { prismaKyselyAdapter } from '@fossyl/prisma-kysely';

export default defineConfig({
  routes: './src/routes',
  output: './src/server.generated.ts',
  adapters: {
    framework: expressAdapter({ cors: true }),
    database: prismaKyselyAdapter({
      kysely: './src/lib/db',      // Path to your Kysely client
      autoMigrate: true,            // Run prisma db push on startup
      defaultTransaction: true,     // Wrap routes in transactions by default
    }),
  },
});
```

### 2. Set up Kysely Client

```typescript
// src/lib/db.ts
import { Kysely, PostgresDialect } from 'kysely';
import { Pool } from 'pg';
import type { DB } from 'prisma/kysely-types'; // Generated by prisma-kysely

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

export const kq = new Kysely<DB>({
  dialect: new PostgresDialect({ pool }),
});
```

### 3. Configure Prisma for Kysely Types

```prisma
// prisma/schema.prisma
generator kysely {
  provider = "prisma-kysely"
  output   = "./kysely-types.ts"
}

model User {
  id    String @id @default(uuid())
  name  String
  email String @unique
}
```

## How It Works

### The Problem

Handler code shouldn't need to know about transactions. This is infrastructure, not business logic.

### The Solution

Use AsyncLocalStorage + Proxy to automatically route queries through active transactions.

```typescript
// Handler code - no transaction awareness
handler: async ({ url }, auth) => {
  const user = await kq.selectFrom('users').where('id', '=', url.id).executeTakeFirst();
  return user;
}

// Generated wrapper handles transaction
const result = await withTransaction(async () => {
  return handler({ url: req.params }, auth);
  // kq queries inside automatically use transaction from context
});
```

## Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `kysely` | `string` | Required | Path to Kysely client module (must export `kq`) |
| `autoMigrate` | `boolean` | `false` | Run `prisma db push` on startup |
| `defaultTransaction` | `boolean` | `true` | Wrap routes in transactions by default |

## Route Transaction Control

Routes can opt out of the default transaction behavior:

```typescript
// Uses transaction (default when defaultTransaction: true)
export const getUser = router.createEndpoint('/users/:id').get({
  handler: async ({ url }) => {
    return kq.selectFrom('users').where('id', '=', url.id).executeTakeFirst();
  },
});

// Opts out of transaction
export const healthCheck = router.createEndpoint('/health').get({
  transaction: false,
  handler: async () => {
    return { status: 'ok', timestamp: Date.now() };
  },
});
```

## Generated Code

When composed with a framework adapter, the database adapter emits:

### Setup Code (imports, context, proxy)

```typescript
import { AsyncLocalStorage } from 'node:async_hooks';
import type { Transaction } from 'kysely';
import { kq as _kq } from './lib/db';

const txContext = new AsyncLocalStorage<Transaction<unknown>>();

function getActiveTransaction(): Transaction<unknown> | undefined {
  return txContext.getStore();
}

const kq = new Proxy(_kq, {
  get(target, prop, receiver) {
    const activeTx = getActiveTransaction();
    if (activeTx) {
      return Reflect.get(activeTx, prop, activeTx);
    }
    return Reflect.get(target, prop, receiver);
  },
});

async function withTransaction<T>(callback: () => Promise<T>): Promise<T> {
  return _kq.transaction().execute(async (tx) => {
    return txContext.run(tx, callback);
  });
}
```

### Wrapper Code (transaction handling)

```typescript
// With transaction
const result = await withTransaction(async () => {
  // handler code
});

// Without transaction
const result = // handler code (unwrapped)
```

### Startup Code (auto-migration)

```typescript
if (process.env.NODE_ENV !== 'test') {
  const { execSync } = await import('child_process');
  console.log('Running database migrations...');
  execSync('npx prisma db push --skip-generate', { stdio: 'inherit' });
}
```

## Advanced Usage

### Direct Context Access

For advanced use cases, you can import context utilities directly:

```typescript
import {
  getActiveTransaction,
  withTransaction,
  withoutTransaction,
  createTransactionProxy,
} from '@fossyl/prisma-kysely';
```

### Manual Transaction Control

```typescript
import { withTransaction, withoutTransaction } from '@fossyl/prisma-kysely';
import { kq } from './lib/db';

// Run with transaction
await withTransaction(kq, async () => {
  await kq.insertInto('users').values({ name: 'John' }).execute();
  await kq.insertInto('profiles').values({ userId: 'john' }).execute();
});

// Run without transaction (even inside a transaction context)
await withoutTransaction(async () => {
  await kq.insertInto('audit_logs').values({ action: 'user_created' }).execute();
});
```

## Package Structure

```
packages/prisma-kysely/
├── src/
│   ├── index.ts      # Public exports
│   ├── adapter.ts    # prismaKyselyAdapter() implementation
│   ├── context.ts    # AsyncLocalStorage transaction context
│   ├── proxy.ts      # Kysely proxy for transaction detection
│   ├── emitter.ts    # Code emission for framework adapters
│   └── types.ts      # Adapter-specific types
├── package.json
├── tsconfig.json
└── CLAUDE.md
```

## Type Exports

```typescript
import type { PrismaKyselyAdapterOptions } from '@fossyl/prisma-kysely';
```

## Peer Dependencies

- `fossyl` - Core framework (provides `DatabaseAdapter` type)
- `kysely` - Type-safe SQL query builder

## Works With

- Any Kysely dialect (PostgreSQL, SQLite, MySQL)
- Any Prisma-supported database
- All fossyl framework adapters
